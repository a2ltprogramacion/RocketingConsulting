---
// @src/pages/index.astro (VERSIÓN 4.24 - Hotfix Proyectos: Centrado y Distribución en Grid)
import { getEntry, getCollection, type CollectionEntry } from "astro:content";
import Layout from "../layouts/Layout.astro";
import { mdToHtml } from "../utils/markdown";
import ServiceCardV4 from "../components/ServiceCardV4.astro";
import ProjectCardV4 from "../components/ProjectCardV4.astro";

// Cargar datos del CMS
const home = await getEntry("pages", "home");
const allServicios = await getCollection("servicios");
const allProyectos = await getCollection("proyectos");
const contacto = await getEntry("informacion-de-contacto", "general");
const ajustes = await getEntry("ajustes", "home");
const allClientes = await getCollection("clientes");

// Validar datos con placeholders (SEO)
const title =
  ajustes?.data.title ??
  "Revisar configuración de SEO en CMS - Titulo no definido";
const description =
  ajustes?.data.description ??
  "Revisar configuración de SEO en CMS - Descripción no definida";

// Cargar datos de secciones
const hero = home?.data.hero ?? {
  show_section: true,
  title: "Convertimos estrategias en impacto",
  cta_text: "Hablemos",
};
const nosotros = home?.data.nosotros ?? {
  show_section: true,
  title: "¿Quiénes Sómos?",
};
const servicios = home?.data.servicios ?? {
  show_section: true,
  title: "Nuestros Servicios",
};
const proyectos = home?.data.proyectos ?? {
  show_section: true,
  title: "Nuestros Proyectos",
};
const clientes = home?.data.clientes ?? {
  show_section: true,
  title: "Clientes que confían en nosotros",
  show_scroller: true,
};
const testimonios = home?.data.testimonios ?? {
  show_section: true,
  title: "Lo que dicen nuestros socios",
};

// --- Renderizar Markdown a HTML ---
function render(md: string | undefined, inline = false): string {
  if (!md) return "";
  const html = mdToHtml(md);
  if (inline) {
    return html
      .trim()
      .replace(/^<p>/i, "")
      .replace(/<\/p>$/i, "");
  }
  return html;
}

// Renderizado de títulos
const heroTitleHtml = render(hero.title, true);
const heroSubtitleHtml = render(hero.subtitle, true);
const heroDescriptionHtml = render(hero.description);
const heroCtaTextHtml = render(hero.cta_text, true);
const nosotrosTitleHtml = render(nosotros.title, true);
const nosotrosContentHtml = render(nosotros.content);
const serviciosTitleHtml = render(servicios.title, true);
const serviciosSubtitleHtml = render(servicios.subtitle, true);
const proyectosTitleHtml = render(proyectos.title, true);
const proyectosSubtitleHtml = render(proyectos.subtitle, true);
const clientesTitleHtml = render(clientes.title, true);
const testimoniosTitleHtml = render(testimonios.title, true);

// Lógica Testimonios
type Testimonio = {
  quote: string;
  author?: string;
  google_review_embed?: string;
};
const testimoniosLista: Testimonio[] = home?.data.testimonios?.lista ?? [];

// Lógica Proyectos Destacados
const titulosProyectosDestacados: string[] =
  home?.data.proyectos?.lista_destacados ?? [];
const proyectosParaMostrar =
  titulosProyectosDestacados.length > 0
    ? allProyectos.filter((proyecto) =>
        titulosProyectosDestacados.includes(proyecto.data.titulo),
      )
    : allProyectos.slice(0, 6); // Fallback: Muestra los primeros 6

// --- LÓGICA DE CLIENTES (V4.21) ---
// 1. Lógica para la Rejilla 3x4
const titulosClientesDestacados: string[] =
  home?.data.clientes?.lista_destacados ?? [];
const clientesParaGrid =
  titulosClientesDestacados.length > 0
    ? allClientes.filter((cliente) =>
        titulosClientesDestacados.includes(cliente.data.titulo),
      )
    : allClientes.slice(0, 12); // Fallback: Muestra los primeros 12

// 2. Lógica para el Scroller (Llenado de 18 slots)
const TARGET_FILL_COUNT = 18; // El número de logos que queremos ver
const clientCount = allClientes.length;
let scrollerList: CollectionEntry<"clientes">[] = []; // Esta será la "Lista A"

if (clientCount > 0 && clientCount < TARGET_FILL_COUNT) {
  const repetitions = Math.ceil(TARGET_FILL_COUNT / clientCount);
  scrollerList = Array(repetitions).fill(allClientes).flat();
} else {
  scrollerList = allClientes;
}
---

<Layout title={title} description={description}>
  <main>
    {
      hero.show_section && (
        <section
          id="inicio"
          class="relative min-h-screen flex items-center bg-accent text-text-inverted pt-10 md:pt-0 prose-color"
        >
          <div class="w-full max-w-screen-xl mx-auto px-8 py-20 md:py-32 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div class="relative z-10 animate-fade-in-up">
              <h1 class="text-4xl md:text-6xl font-bold mb-4 ">
                <span
                  class="prose prose-invert max-w-none prose-strong:text-primary prose-unsize text-5xl md:text-6xl"
                  set:html={heroTitleHtml}
                ></span>
              </h1>

              {hero.subtitle && (
                <p class="mb-4">
                  <span
                    class="prose prose-invert max-w-none prose-strong:text-primary prose-unsize text-xl"
                    set:html={heroSubtitleHtml}
                  ></span>
                </p>
              )}

              {hero.description && (
                <div
                  class="prose prose-xl prose-invert max-w-none prose-strong:text-primary prose-unsize text-lg"
                  set:html={heroDescriptionHtml}
                />
              )}

              {hero.cta_text && (
                <a
                  href={hero.cta_url ?? "#contacto"}
                  class="bg-primary text-text-inverted font-bold py-3 px-8 text-lg hover:bg-accent hover:text-primary hover:border-2 inline-block hover:no-underline"
                >
                  <span
                    class="prose prose-invert max-w-none prose-strong:text-accent prose-unsize text-lg"
                    set:html={heroCtaTextHtml}
                  />
                </a>
              )}
            </div>

            {/* (Imágenes sin cambios V4.9) */}
            <div class="relative flex items-center justify-center min-h-[400px]">
              {hero.image_logo && (
                <img
                  src={hero.image_logo}
                  alt="Logo"
                  class="absolute inset-0 w-full h-full object-contain transform scale-100"
                />
              )}
              {hero.image_main && (
                <img
                  src={hero.image_main}
                  alt="Imagen Hero"
                  class="relative z-10 min-w-72 max-w-md object-cover"
                />
              )}
              {!hero.image_logo && !hero.image_main && (
                <div class="relative z-10 w-full max-w-md h-80 bg-black/10 flex items-center justify-center text-text-inverted/50">
                  (Imágenes se mostrarán aquí)
                </div>
              )}
            </div>
          </div>
        </section>
      )
    }

    {
      nosotros.show_section && (
        <section
          id="nosotros"
          class="relative py-24 bg-cover bg-center bg-no-repeat md:h-[600px]"
          style={
            nosotros.background_image
              ? "background-image: url(" + nosotros.background_image + ")"
              : "background-color: #eee;"
          }
        >
          <div class="relative w-full max-w-screen-xl mx-auto px-8 lg:-mt-36">
            <div class="w-full md:w-1/2 lg:w-2/5 mr-auto">
              <div class="bg-primary text-text-inverted md:w-[600px] p-8 md:p-12 shadow-xl">
                <h2 class="mb-4">
                  <span
                    class="prose prose-invert max-w-none prose-strong:text-accent prose-unsize text-4xl"
                    set:html={nosotrosTitleHtml}
                  ></span>
                </h2>

                <div class="prose prose-lg prose-invert max-w-none prose-strong:text-accent prose-unsize text-lg">
                  <span set:html={nosotrosContentHtml} />
                </div>
              </div>
            </div>
          </div>
        </section>
      )
    }

    {
      servicios.show_section && (
        <section id="servicios" class="py-20 px-8 bg-accent text-text-inverted">
          <div class="w-full max-w-screen-2xl mx-auto text-center">
            <h2 class="mb-4">
              <span
                class="prose prose-invert max-w-none prose-strong:text-primary prose-unsize text-5xl"
                set:html={serviciosTitleHtml}
              ></span>
            </h2>

            {servicios.subtitle && (
              <p class="max-w-2xl mx-auto mb-12">
                <span
                  class="prose prose-invert max-w-none prose-strong:text-primary prose-unsize text-2xl"
                  set:html={serviciosSubtitleHtml}
                ></span>
              </p>
            )}
            {/* REVERTIDO: Servicios - Vuelve a la configuración original de grid */}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-left">
              {allServicios.map((servicio) => (
                <ServiceCardV4 servicio={servicio} />
              ))}
            </div>
          </div>
        </section>
      )
    }

    {
      proyectos.show_section && (
        <section id="proyectos" class="py-20 px-8 bg-secondary">
          <div class="w-full max-w-screen-desktop-lg mx-auto text-center">
            <h2 class="mb-4 text-primary">
              <span
                class="prose max-w-none prose-strong:text-accent prose-unsize prose-invert text-7xl text-primary"
                set:html={proyectosTitleHtml}
              ></span>
            </h2>

            {proyectos.subtitle && (
              <p class="max-w-2xl mx-auto mb-12">
                <span
                  class="prose max-w-none prose-strong:text-accent prose-unsize text-2xl"
                  set:html={proyectosSubtitleHtml}
                ></span>
              </p>
            )}

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 justify-items-center gap-2 max-w-screen-2xl mx-auto">
              {proyectosParaMostrar.map((project) => (
                <ProjectCardV4 project={project} />
              ))}
            </div>

            <div class="mt-12">
              <a
                href="/proyectos"
                class="bg-primary text-text-inverted font-bold py-3 px-8 text-lg hover:bg-accent hover:text-primary hover:border-2 inline-block hover:no-underline"
              >
                Ver Todos los Proyectos
              </a>
            </div>
          </div>
        </section>
      )
    }

    {
      clientes.show_section && (
        <section id="clientes" class="pt-20">
          <div class="bg-accent text-text-inverted py-16 text-center">
            <h2 class="font-bold ">
              <span
                class="prose prose-invert max-w-none prose-strong:text-primary prose-unsize prose-invert text-7xl"
                set:html={clientesTitleHtml}
              ></span>
            </h2>
          </div>

          <div class="bg-primary py-20">
            <div class="w-full max-w-screen-2xl mx-auto px-8">
              {/* Clientes Grid - Se mantiene el flex-wrap justify-center que funciona bien aquí */}
              <div class="flex flex-wrap justify-center gap-x-4 gap-y-4 max-w-7xl mx-auto">
                {clientesParaGrid.map((cliente) =>
                  cliente.data.url ? (
                    <a
                      href={cliente.data.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block text-center opacity-70 transition-opacity duration-300 hover:opacity-100"
                      title={cliente.data.titulo}
                    >
                      <img
                        src={cliente.data.logo}
                        alt={cliente.data.titulo}
                        class="h-72 w-auto object-contain mx-auto"
                      />
                    </a>
                  ) : (
                    <div
                      class="text-center opacity-70"
                      title={cliente.data.titulo}
                    >
                      <img
                        src={cliente.data.logo}
                        alt={cliente.data.titulo}
                        class="h-72  w-auto object-contain mx-auto"
                      />
                    </div>
                  ),
                )}
              </div>
              {clientesParaGrid.length === 0 && (
                <p class="text-text-inverted/50 text-center mt-8">
                  Logos de clientes destacados se mostrarán aquí.
                </p>
              )}
            </div>
          </div>

          {clientes.show_scroller && scrollerList.length > 0 && (
            <div class="bg-secondary py-12 marquee-viewport">
              <div class="marquee-track">
                <div class="marquee-list">
                  {scrollerList.map((cliente) => (
                    <img
                      src={cliente.data.logo}
                      alt={cliente.data.titulo}
                      title={cliente.data.titulo}
                      class="h-32 w-auto object-contain"
                    />
                  ))}
                </div>

                <div class="marquee-list" aria-hidden="true">
                  {scrollerList.map((cliente) => (
                    <img
                      src={cliente.data.logo}
                      alt={cliente.data.titulo}
                      title={cliente.data.titulo}
                      class="h-32 w-auto object-contain"
                    />
                  ))}
                </div>
              </div>
            </div>
          )}
        </section>
      )
    }

    {
      testimonios.show_section && (
        <section id="testimonios" class="bg-secondary py-20 px-8 text-primary">
          <div class="w-full max-w-screen-2xl mx-auto text-center">
            <h2 class="mb-12">
              <span
                class="prose max-w-none prose-strong:text-accent prose-unsize text-5xl"
                set:html={testimoniosTitleHtml}
              ></span>
            </h2>

            {testimoniosLista.length > 0 ? (
              <div class="relative max-w-4xl mx-auto">
                <div class="overflow-hidden" id="clientes-viewport">
                  <div
                    class="flex transition-transform duration-700 ease-in-out"
                    id="clientes-track"
                    style="transform: translateX(0%);"
                  >
                    {testimoniosLista.map((cliente: Testimonio) => (
                      <div class="min-w-full p-6 flex-shrink-0 flex items-center justify-center">
                        <div class="w-full max-w-3xl bg-white p-8 shadow-md text-left clientes-card border-l-4 border-accent">
                          {cliente.google_review_embed ? (
                            <div set:html={cliente.google_review_embed} />
                          ) : (
                            <>
                              <p class="text-lg md:text-xl italic mb-4 quote whitespace-normal break-words text-text-base">
                                <span set:html={mdToHtml(cliente.quote)} />
                              </p>
                              <p class="font-bold text-right mt-4 author text-primary">
                                - {cliente.author}
                              </p>
                            </>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  aria-label="Anterior"
                  id="clientes-prev"
                  class="absolute left-2 top-1/2 -translate-y-1/2 bg-primary/20 hover:bg-primary/40 text-primary rounded-full w-10 h-10 flex items-center justify-center"
                >
                  ‹
                </button>
                <button
                  aria-label="Siguiente"
                  id="clientes-next"
                  class="absolute right-2 top-1/2 -translate-y-1/2 bg-primary/20 hover:bg-primary/40 text-primary rounded-full w-10 h-10 flex items-center justify-center"
                >
                  ›
                </button>
                <div
                  id="clientes-dots"
                  class="flex justify-center gap-3 mt-6"
                />
              </div>
            ) : (
              <p class="text-text-base/70">
                (Los testimonios de los clientes se mostrarán aquí cuando se
                carguen en el CMS)
              </p>
            )}
          </div>
        </section>
      )
    }
  </main>
</Layout>

<style>
  /* Animación fade-in-up */
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in-up {
    animation: fade-in-up 1s ease-out forwards;
  }

  /* Estilos del Carrusel (Testimonios) */
  #clientes-dots button {
    width: 10px;
    height: 10px;
    border-radius: 9999px;
    background: theme("colors.primary / 0.4");
    border: none;
  }
  #clientes-dots button.active {
    background: theme("colors.primary");
  }

  .clientes-card {
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .clientes-card .quote {
    line-height: 1.5;
    max-height: 28vh;
    overflow: auto;
  }
  .clientes-card .author {
    margin-top: 1rem;
  }
  .clientes-card,
  .clientes-card .quote {
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  @media (min-width: 768px) {
    .clientes-card {
      min-height: 200px;
    }
  }

  /* --- Estilos del Scroller Infinito (Marquesina) - Sin cambios --- */
  @keyframes marquee-scroll {
    0% {
      transform: translateX(0%);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .marquee-viewport {
    overflow: hidden;
    width: 100%;
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
  }

  .marquee-track {
    display: flex;
    width: fit-content;
    animation: marquee-scroll 60s linear infinite;
  }

  .marquee-track:hover {
    animation-play-state: paused;
  }

  .marquee-list {
    display: flex;
    align-items: center;
    gap: 4rem; /* 64px de espacio entre logos */
    padding: 0 2rem; /* 32px de padding en los extremos */
    flex-shrink: 0; /* Evita que la lista se encoja */
  }
  .marquee-list img {
    flex-shrink: 0; /* Evita que los logos se encojan */
  }
</style>

<script>
  // Script del carrusel de testimonios (V4.1 CON TIPOS)
  document.addEventListener("DOMContentLoaded", () => {
    (function () {
      const track = document.getElementById("clientes-track");
      const prev = document.getElementById("clientes-prev");
      const next = document.getElementById("clientes-next");
      const dotsContainer = document.getElementById("clientes-dots");
      const viewport = document.getElementById("clientes-viewport");

      if (!track || !dotsContainer) return;
      const slides = Array.from(track.children);
      const total = slides.length;
      if (total === 0) return; // Si no hay slides, no hacer nada

      let index: number = 0;
      let timer: number | null = null;
      const interval = 10000;

      function goTo(i: number) {
        index = (i + total) % total;
        if (track)
          (track as HTMLElement).style.transform =
            `translateX(-${index * 100}%)`;
        // --- LÍNEA CORREGIDA (V4.15) ---
        if (dotsContainer)
          Array.from(dotsContainer.children).forEach((b, idx) =>
            (b as HTMLElement).classList.toggle("active", idx === index),
          );
      }

      function nextSlide() {
        goTo(index + 1);
      }
      function prevSlide() {
        goTo(index - 1);
      }

      for (let i = 0; i < total; i++) {
        const b = document.createElement("button");
        b.type = "button";
        b.addEventListener("click", () => {
          goTo(i);
          resetTimer();
        });
        dotsContainer.appendChild(b);
      }

      if (next)
        next.addEventListener("click", () => {
          nextSlide();
          resetTimer();
        });
      if (prev)
        prev.addEventListener("click", () => {
          prevSlide();
          resetTimer();
        });

      function startTimer() {
        if (timer) clearInterval(timer as number);
        timer = window.setInterval(() => {
          nextSlide();
        }, interval);
      }
      function stopTimer() {
        if (timer) {
          clearInterval(timer as number);
          timer = null;
        }
      }
      function resetTimer() {
        stopTimer();
        startTimer();
      }

      [viewport, track, prev, next, dotsContainer].forEach((el) => {
        if (!el) return;
        el.addEventListener("mouseenter", () => {
          stopTimer();
        });
        el.addEventListener("mouseleave", () => {
          startTimer();
        });
        el.addEventListener("focusin", () => {
          stopTimer();
        });
        el.addEventListener("focusout", () => {
          startTimer();
        });
      });
      goTo(0);
      startTimer();
    })();
  });
</script>
