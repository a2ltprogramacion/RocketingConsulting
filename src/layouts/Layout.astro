---
// @src/layouts/Layout.astro (VERSIÓN 4.14 - SEO SEPARADO)
import '../styles/global.css';
import Header from '../components/Header.astro';
import { getEntry } from 'astro:content';

export interface Props {
	title: string;
	description: string;
  
}

const { title, description } = Astro.props;
const gaId = import.meta.env.PUBLIC_GA_ID || 'G-1A2B3C4D5E';

// --- CAMBIO CLAVE: Cargar 'ajustes' para obtener brand_name ---
const ajustes = await getEntry('ajustes', 'home');
const brand_name = ajustes?.data.brand_name ?? 'TEST';

// Datos de contacto
const contacto = await getEntry('informacion-de-contacto', 'general');
const c = contacto?.data ?? {};
const waNumber = c.whatsapp ?? '';
const waMsg = encodeURIComponent(c.whatsapp_message ?? 'Hola, quiero cotizar un proyecto');
const waHref = waNumber ?
`https://wa.me/${waNumber}?text=${waMsg}` : null;
const email = c.email;
---

<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />

		<title>{title}</title>
		<meta name="description" content={description} />
		<meta name="author" content="Angel Argenis León Torres - A2LT Soluciones Integrales" />

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">

		{gaId && (
			<>
				<script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}></script>
				<script is:inline define:vars={{ gaId }}>
					window.dataLayer = window.dataLayer || [];
					function gtag(){dataLayer.push(arguments);}
					gtag('js', new Date());
					gtag('config', gaId);
				</script>
			</>
		)}

    </head>
	<body class="bg-secondary font-sans">
		<Header />
		<main class="w-full">
			<slot />
		</main>
		
    {/* Botón Flotante de WhatsApp */}
    {waHref ? (
			<a href={waHref} target="_blank" rel="noopener noreferrer" class="floating-whatsapp" aria-label="Contactar por WhatsApp">
				<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.89-5.451 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.289.173-1.413z"/></svg>
			</a>
		) : null}

    {/* Botón Flotante "Subir al Inicio" */}
    <a href="#inicio" id="scroll-to-top" class="floating-scroll-top" aria-label="Volver al inicio">
     
       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 2c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10-4.477-10-10-10zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm-1-8.414l-2.293 2.293-1.414-1.414 4.707-4.707 4.707 4.707-1.414 1.414-2.293-2.293v4.414h-2v-4.414z"/></svg>
    </a>

    {/* Tooltip de Email (oculto por defecto) */}
    <div id="email-tooltip" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-4 py-2 bg-green-600 text-white text-sm opacity-0 transition-opacity duration-300 pointer-events-none">
      ¡Dirección de correo copiada!
    </div>

    {/* Footer V4.0 */}
		<footer id="footer" class="bg-primary text-text-inverted py-16 px-8">
			<div id="contacto" class="container mx-auto text-center max-w-4xl">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">
          {c.contact_heading ?? '¿Listo para empezar?'}
        </h2>
        <p class="text-lg md:text-xl text-text-inverted/80 mb-8 max-w-2xl mx-auto">
          {c.contact_subheading ?? 'Conversemos por WhatsApp para una respuesta más rápida o envíame un correo.'}
        </p>

        {/* CTAs del Footer */}
        <div class="flex justify-center items-center gap-4 flex-wrap">
          {waHref && (
            <a href={waHref}
                class="bg-[#25D366] text-white font-bold py-3 px-8 text-lg transition-transform duration-300 hover:scale-105 hover:shadow-lg"
                target="_blank" rel="noopener noreferrer">
              Contactar por WhatsApp
            </a>
          )}
          {email && (
            <a 
                id="email-copy-button"
                href={`mailto:${email}`} 
                data-email={email}
                class="bg-accent text-primary font-bold py-3 px-8 text-lg transition-all duration-300 ease-in-out hover:bg-white hover:text-accent border-2 border-accent">
              {email}
            </a>
          )}
        </div>

    
         {/* Copyright */}
        <div class="mt-16 border-t border-white/10 pt-8">
          <p class="text-sm text-text-inverted/60">
            &copy; {new Date().getFullYear()} {brand_name}, Todos los derechos reservados.
            <span class="block md:inline-block md:ml-2">
              Diseño: <span class="font-bold text-accent hover:text-white transition-colors duration-300">A2LT Soluciones Integrales</span>
            </span>
          </p>
        </div>
			</div>
		</footer>
	</body>
</html>

<style is:global>
  html {
		scroll-behavior: smooth;
  }
	body {
		margin: 0;
  }
	.floating-whatsapp {
		position: fixed;
		bottom: 20px;
		right: 20px;
		background-color: #25D366;
		color: white;
		padding: 12px;
		border-radius: 50% !important;
		box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		z-index: 1000;
		transition: transform 0.3s ease-in-out;
	}
	.floating-whatsapp:hover {
		transform: scale(1.1);
  }

  /* NUEVO V4.1: Botón Scroll to Top */
  .floating-scroll-top {
    position: fixed;
    bottom: 20px;
    /* Centrado */
    left: 50%;
    transform: translateX(-50%); 
    
    background-color: theme('colors.primary / 0.5');
    /* Gris transparente */
    backdrop-filter: blur(4px);
    color: white;
    padding: 10px;
    border-radius: 50% !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 999;
    transition: all 0.3s ease-in-out;
    opacity: 0;
    /* Oculto por defecto */
    pointer-events: none;
    /* No Clickeable por defecto */
  }
  .floating-scroll-top:hover {
		transform: translateX(-50%) scale(1.1);
    background-color: theme('colors.primary / 0.8');
  }
  /* Clase 'visible' que añadirá el script */
  .floating-scroll-top.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* NUEVO V4.1: Tooltip de Email */
  #email-tooltip.visible {
    opacity: 1;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // --- Lógica de Scroll-to-Top ---
    const scrollTopButton = document.getElementById('scroll-to-top');

    if (scrollTopButton) {
      window.addEventListener('scroll', () => {
        // Mostrar el botón si el scroll es mayor a la altura de la ventana
        if (window.scrollY > window.innerHeight) {
          scrollTopButton.classList.add('visible');
        } else {
          scrollTopButton.classList.remove('visible');
        }
      });
    }

    // --- Lógica de Copiar Correo ---
    const emailButton = document.getElementById('email-copy-button');
    const tooltip = document.getElementById('email-tooltip');

    if (emailButton && tooltip) {
      emailButton.addEventListener('click', (e) => {
        // 1. Prevenir la acción de 'mailto:'
        e.preventDefault(); 
        
        const email = emailButton.getAttribute('data-email');
        
        if (email) {
          // 2. Usar la API de Portapapeles
          navigator.clipboard.writeText(email)
            .then(() => {
              // 3. Mostrar confirmación
              tooltip.classList.add('visible');
              // 4. Ocultar después de 2 segundos
              setTimeout(() => {
                tooltip.classList.remove('visible');
              }, 2000);
            })
            .catch(err => {
              console.error('Fallo al copiar el correo: ', err);
              // Fallback: si falla, ejecutar la acción original
              window.location.href = `mailto:${email}`;
            });
        }
      });
    }
  });
</script>