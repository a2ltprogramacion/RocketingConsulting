---
// @src/pages/servicios/index.astro
import { getCollection, getEntry } from "astro:content";
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";

// 1. Obtener la colección de servicios (Lógica original)
const allServices = await getCollection("services");
const services = allServices.sort((a, b) => a.data.order - b.data.order);

// 2. INTENTO DE CONEXIÓN CMS (Con Red de Seguridad)
// Intentamos leer el archivo 'services.md'. Si no existe, 'pageEntry' será undefined.
const pageEntry = await getEntry("pages", "services");
const cmsData = pageEntry?.data;

// 3. DEFINICIÓN DE DATOS (Prioridad: CMS > Texto Fijo)
// Si hay dato en CMS, úsalo. Si no, usa el texto fijo que ya tenías aprobado.
const title = cmsData?.title || "Soluciones Tecnológicas";
const subtitle =
  cmsData?.subtitle ||
  "Ingeniería de precisión para transformar tu infraestructura digital.";

// Configuración SEO (Mezclando CMS y Defaults)
const seoConfig = {
  meta_title:
    cmsData?.seo?.meta_title || "Nuestros Servicios | A2LT Soluciones",
  meta_description:
    cmsData?.seo?.meta_description ||
    "Catálogo de soluciones en ingeniería, desarrollo web y automatización de procesos.",
  social_image: cmsData?.seo?.social_image, // Si no hay, el Layout usará la default
  social_image_alt: "Catálogo de Servicios A2LT",
};

// Imagen de fondo opcional (Hero)
const heroBg = cmsData?.hero_bg;
---

<Layout seo={seoConfig}>
  {/* HEADER DE SECCIÓN */}
  <section class="relative py-24 bg-[#0f1115] overflow-hidden">
    {/* Fondo: Imagen (si existe en CMS) o Efecto Neón (Default) */}
    {
      heroBg ? (
        <div class="absolute inset-0 z-0">
          <Image
            src={heroBg}
            alt="Fondo Servicios"
            class="w-full h-full object-cover opacity-90"
            width={1920}
            height={600}
          />
          <div class="absolute inset-0 bg-linear-to-t from-[#0f1115] via-[#0f1115]/80 to-transparent" />
        </div>
      ) : (
        <>
          {/* Fondo ambiental (Neón sutil original) */}
          <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[60%] h-px bg-linear-to-r from-transparent via-primary/50 to-transparent" />
          <div class="absolute top-10 right-0 w-96 h-96 bg-primary/5 blur-[100px] rounded-full pointer-events-none" />
        </>
      )
    }

    <div class="container mx-auto px-6 text-center relative z-10 pt-10">
      <h1 class="text-4xl md:text-6xl font-heading font-bold text-white mb-6">
        {title}
      </h1>
      <p class="text-xl text-gray-400 max-w-2xl mx-auto font-light">
        {subtitle}
      </p>
    </div>
  </section>

  {/* GRILLA DE SERVICIOS */}
  <section class="py-16 bg-background min-h-[50vh]">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {
          services.map((service) => (
            <article class="group relative bg-surface/30 border border-white/5 rounded-2xl overflow-hidden hover:border-primary/30 transition-all duration-500 hover:-translate-y-2 shadow-lg hover:shadow-primary/10">
              {/* Imagen Principal (Cover) */}
              <div class="aspect-video overflow-hidden">
                <Image
                  src={service.data.main_image}
                  alt={service.data.main_image_alt || service.data.title}
                  class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700"
                  width={800}
                  height={450}
                />
                {/* Overlay Gradiente */}
                <div class="absolute inset-0 bg-linear-to-t from-[#0f1115] to-transparent opacity-80" />
              </div>

              {/* Contenido de la Card */}
              <div class="p-8 relative">
                <h2 class="text-2xl font-heading font-bold text-white mb-4 group-hover:text-primary transition-colors">
                  {service.data.title}
                </h2>

                <p class="text-gray-400 mb-6 line-clamp-3 leading-relaxed">
                  {service.data.description}
                </p>

                <div class="flex justify-between items-center border-t border-white/10 pt-6">
                  <span class="text-sm text-gray-500 font-mono">
                    {service.data.price || "Consultar"}
                  </span>

                  <a
                    href={`/servicios/${service.slug}`}
                    class="inline-flex items-center gap-2 text-white font-bold text-sm hover:text-primary transition-colors"
                  >
                    Ver Detalles
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 8l4 4m0 0l-4 4m4-4H3"
                      />
                    </svg>
                  </a>
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </div>
  </section>
</Layout>
